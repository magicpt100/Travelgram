<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Colorlib Templates">
    <meta name="author" content="Colorlib">
    <meta name="keywords" content="Colorlib Templates">

    <!-- Title Page-->
    <title>Edit a Trip</title>

    <!-- Font special for pages-->
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="icon" href="assets/img/icon.png">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- <link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css"> -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap-datetimepicker.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap-tokenfield.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" />

</head>

<body>
<div class="page-wrapper bg-dark p-t-100 p-b-50">
    <div class="wrapper wrapper--w900">
        <div class="card card-6">
            <div class="card-heading">
                <h2 class="title">Edit a Trip</h2>
            </div>

            <div class="card-body">
                <form id="edit-trip-form" method="POST">
                    <div class="form-row">
                        <div class="name">Trip Title</div>
                        <div class="value">
                            <input class="input--style-6" type="text" name="trip_title" placeholder="Times Square" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="name">Start Date &<br/> End Date</div>
                        <div class="value">
                            <div class="container-fluid">
                                <div class='col-md-6'>
                                    <div class="form-group">
                                        <div class='input-group date' id='datetimepicker1'>
                                            <input type='text' class="form-control" name="datetime1" required/>
                                            <span class="input-group-addon">
                                                  <span class="glyphicon glyphicon-calendar"></span>
                                              </span>
                                        </div>
                                    </div>
                                </div>
                                <div class='col-md-6'>
                                    <div class="form-group">
                                        <div class='input-group date' id='datetimepicker2'>
                                            <input type='text' class="form-control" name="datetime2" required/>
                                            <span class="input-group-addon">
                                                  <span class="glyphicon glyphicon-calendar"></span>
                                              </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="name">Destination</div>
                        <div class="value">
                            <input class="input--style-6" type="text" name="dest" placeholder="42nd Street" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="name">Tags</div>
                        <div class="value">
                            <input type="text" class="form-control" id="tokenfield" />
                        </div>
                    </div>
                    <button type="submit" style="display: none"></button>
                </form>
            </div>
            <div class="card-footer">
                <button id="update-trip" class="btn btn--radius-2 btn--blue-2" type="submit">Create Trip</button>
                <button id="cancel" class="btn btn--radius-2 btn--red" type="submit">Cancel</button>
            </div>
        </div>
    </div>
</div>


<!-- AWS APIGclient -->
<!-- import amazon sdk -->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.415.0.min.js"></script>
<script src="js/aws-cognito-sdk.min.js"></script>
<script src="js/amazon-cognito-identity.min.js"></script>
<!-- import the generated sdk -->
<script type="text/javascript" src="js/lib/axios/dist/axios.standalone.js"></script>
<script type="text/javascript" src="js/lib/CryptoJS/rollups/hmac-sha256.js"></script>
<script type="text/javascript" src="js/lib/CryptoJS/rollups/sha256.js"></script>
<script type="text/javascript" src="js/lib/CryptoJS/components/hmac.js"></script>
<script type="text/javascript" src="js/lib/CryptoJS/components/enc-base64.js"></script>
<script type="text/javascript" src="js/lib/url-template/url-template.js"></script>
<script type="text/javascript" src="js/lib/apiGatewayCore/sigV4Client.js"></script>
<script type="text/javascript" src="js/lib/apiGatewayCore/apiGatewayClient.js"></script>
<script type="text/javascript" src="js/lib/apiGatewayCore/simpleHttpClient.js"></script>
<script type="text/javascript" src="js/lib/apiGatewayCore/utils.js"></script>
<script type="text/javascript" src="js/apigClient.js"></script>


<!-- Jquery JS-->
<!-- <script src="vendor/jquery/jquery.min.js"></script> -->
<!-- Main JS-->
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
<script src="https://momentjs.com/downloads/moment.js"></script>
<script src="js/transition.js"></script>
<script src="js/collapse.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="js/bootstrap-datetimepicker.js"></script>
<script type="text/javascript">
    $(function () {
        $('#datetimepicker1').datetimepicker({
            format: "L"
        });
        $('#datetimepicker2').datetimepicker({
            useCurrent: false, //Important! See issue #1075
            format: "L"
        });
        $("#datetimepicker1").on("dp.change", function (e) {
            $('#datetimepicker2').data("DateTimePicker").minDate(e.date);
        });
        $("#datetimepicker2").on("dp.change", function (e) {
            $('#datetimepicker1').data("DateTimePicker").maxDate(e.date);
        });
    });
</script>
<script src="js/bootstrap-tokenfield.min.js"></script>

<script src="js/function.js"></script>
<script type="text/javascript">
    // var id_token = location.hash.substring(1).split("&")[0].split("=")[1];
    var url = new URL(window.location.href);
    var id_token = url.searchParams.get("id_token");

    var parseJwt = function (token) {
        try {
            // Get Token Header
            const base64HeaderUrl = token.split('.')[0];
            const base64Header = base64HeaderUrl.replace('-', '+').replace('_', '/');
            const headerData = JSON.parse(window.atob(base64Header));

            // Get Token payload and date's
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace('-', '+').replace('_', '/');
            const dataJWT = JSON.parse(window.atob(base64));
            dataJWT.header = headerData;
            return dataJWT;
        } catch (err) {
            return false;
        }
    };

    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    function get_date(date) {
        date = new Date(date*1000);
        var d = date;
        return (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear()
    }


    var username = parseJwt(id_token)["cognito:username"];

    apigClient = apigClientFactory.newClient({apiKey: 'liZiiPAuQY3d4Hpmojgv25SgyoLqQX2e1pTpoRYU'});
    var tripData;
    apigClient.getonetripTripIDGet({"TripID": 1}, null, {headers:{"Authorization": id_token}})
        .then(function(result){
            console.log(result['data']);
            tripData = result['data'];

            $("input[name=trip_title]").val(tripData['Title']);

            $("input[name=datetime1]").val(get_date(tripData['StartTime']));
            $("input[name=datetime2]").val(get_date(tripData['EndTime']));


            $("input[name=dest]").val(tripData['Dst']);

            apigClient.tagsTagNumGet({"tagNum": 10}, {}, {})
                .then(function(result2){
                    console.log(result2['data']);
                    $('#tokenfield').tokenfield({
                        autocomplete: {
                            source: result2['data'],
                            delay: 100
                        },
                        tokens: tripData['Tags'].join(),
                        showAutocompleteOnFocus: true
                    });

                });

        }).catch( function(result){
        console.log("there is something wrong!!!");
        // Add error callback code here.
    });


    $( "#update-trip" ).click(async function() {
        var $myForm = $('#edit-trip-form');
        if(! $myForm[0].checkValidity()) {
            // If the form is invalid, submit it. The form won't actually submit;
            // this will just cause the browser to display the native HTML5 error messages.
            $myForm.find(':submit').click();
        }else {
            $('body').append("<div id=\"loader\"></div>");
            var trip_name = $("input[name=trip_title]").val();
            var datetime1 = new Date($("input[name=datetime1]").val());
            var datetime2 = new Date($("input[name=datetime2]").val());

            var destination = $("input[name=dest]").val();
            var tags = $("input[id=tokenfield]").val().split(", ");


            var body = {
                'TripID':parseInt(url.searchParams.get("TripID")),
                'Title':trip_name,
                'Dst': destination,
                'StartTime':parseInt(datetime1.getTime())/1000,
                'EndTime':parseInt(datetime2.getTime())/1000,
                'Tags':tags
            };

            var params = {
                'userName':username
            };
            apigClient.userUserNameTripPut(params, body, {headers:{"Authorization": id_token}})
                .then(function(result){
                    console.log(result);
                    // sendMessage(jQuery.parseJSON(result.data.body).message, "left")
                    // Add success callback code here.
                }).catch( function(result){
                console.log("there is something wrong!!!");
                // Add error callback code here.
            });
        }

    });

</script>


</body><!-- This templates was made by Colorlib (https://colorlib.com) -->

</html>
<!-- end document-->
